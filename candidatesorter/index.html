<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดเรียงลำดับผู้ร่วมดีเบต - เจียงใหม่ดีเบต 69</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@100;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #1e2542; 
            color: white;
            overflow-x: hidden; /* ป้องกัน scroll แนวนอน */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.6s ease-out forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Drag & Drop Styling */
        .drag-item {
            cursor: grab;
        }
        .drag-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            border: 2px dashed #00c0fa;
            background: rgba(0, 192, 250, 0.1);
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- IndexedDB Helper (คงเดิม เพื่อให้ฐานข้อมูลตรงกัน) ---
        const DB_NAME = 'CM108_Debate_System';
        const DB_VERSION = 1;
        const STORE_NAME = 'app_data';

        const dbHelper = {
            open: () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME);
                        }
                    };
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            save: async (key, data) => {
                try {
                    const db = await dbHelper.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        store.put(data, key);
                        tx.oncomplete = () => resolve();
                        tx.onerror = (event) => reject(event.target.error);
                    });
                } catch (e) { console.error("DB Save Error", e); }
            },
            get: async (key) => {
                try {
                    const db = await dbHelper.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(STORE_NAME, 'readonly');
                        const store = tx.objectStore(STORE_NAME);
                        const request = store.get(key);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = (event) => reject(event.target.error);
                    });
                } catch (e) { return null; }
            }
        };

        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Grip: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
        };

        const compressImage = (file, maxWidth = 500, quality = 0.7, format = 'image/jpeg', fillWhite = true) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                        else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        if (fillWhite) { ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, width, height); }
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL(format, quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const App = () => {
            const [candidates, setCandidates] = React.useState([]);
            const [dataLoaded, setDataLoaded] = React.useState(false);
            
            const [logoUrl, setLogoUrl] = React.useState(null);
            const [bgUrl, setBgUrl] = React.useState(null);

            const logoInputRef = React.useRef(null);
            const bgInputRef = React.useRef(null);
            const backupInputRef = React.useRef(null);

            // Drag & Drop State
            const dragItem = React.useRef(null);
            const dragOverItem = React.useRef(null);

            // Initial Load
            React.useEffect(() => {
                const loadData = async () => {
                    try {
                        const savedCandidates = await dbHelper.get('candidates') || [];
                        const savedLogo = await dbHelper.get('logo');
                        const savedBg = await dbHelper.get('bg');
                        if (savedCandidates.length === 0) {
                             const localCand = localStorage.getItem('cm108_candidates');
                             if (localCand) setCandidates(JSON.parse(localCand));
                             const localLogo = localStorage.getItem('cm108_logo');
                             if (localLogo) setLogoUrl(localLogo);
                        } else {
                             setCandidates(savedCandidates);
                        }
                        if (savedLogo) setLogoUrl(savedLogo);
                        if (savedBg) setBgUrl(savedBg);
                        setDataLoaded(true);
                    } catch (err) {
                        console.error("DB Load Error", err);
                        setDataLoaded(true);
                    }
                };
                loadData();
            }, []);

            React.useEffect(() => {
                if (dataLoaded) {
                    dbHelper.save('candidates', candidates);
                    try { localStorage.setItem('cm108_candidates', JSON.stringify(candidates)); } catch(e){}
                }
            }, [candidates, dataLoaded]);

            const handleLogoUpload = async (e) => {
                if (e.target.files[0]) {
                    try {
                        const compressed = await compressImage(e.target.files[0], 400, 0.8, 'image/png', false); 
                        setLogoUrl(compressed);
                        dbHelper.save('logo', compressed);
                    } catch (error) {}
                }
            };
            const handleBgUpload = async (e) => {
                if (e.target.files[0]) {
                    try {
                        const compressed = await compressImage(e.target.files[0], 1024, 0.7, 'image/jpeg', true);
                        setBgUrl(compressed);
                        dbHelper.save('bg', compressed);
                    } catch (error) {}
                }
            };
            const addCandidate = () => setCandidates([...candidates, { id: Date.now(), name: '', party: '', color: '#00c0fa', img: null, partyLogo: null }]);
            const updateCandidate = (id, field, value) => setCandidates(candidates.map(c => c.id === id ? { ...c, [field]: value } : c));
            const removeCandidate = (id) => setCandidates(candidates.filter(c => c.id !== id));
            const handleImageUpload = async (id, field, file) => {
                if (file) {
                    try {
                        const isPartyLogo = field === 'partyLogo';
                        const compressed = await compressImage(file, 500, 0.7, isPartyLogo ? 'image/png' : 'image/jpeg', !isPartyLogo);
                        updateCandidate(id, field, compressed);
                    } catch (error) {}
                }
            };

            const handleExport = () => {
                const data = { candidates, logoUrl, bgUrl };
                const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cm108_data_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.candidates) setCandidates(data.candidates);
                        if (data.logoUrl) { setLogoUrl(data.logoUrl); dbHelper.save('logo', data.logoUrl); }
                        if (data.bgUrl) { setBgUrl(data.bgUrl); dbHelper.save('bg', data.bgUrl); }
                        alert("กู้คืนข้อมูลสำเร็จ!");
                    } catch (err) { alert("ไฟล์ไม่ถูกต้อง"); }
                };
                reader.readAsText(file);
            };

            // --- Drag and Drop Handlers ---
            const handleSort = () => {
                // duplicate items
                let _candidates = [...candidates];
                // remove and save the dragged item content
                const draggedItemContent = _candidates.splice(dragItem.current, 1)[0];
                // switch the position
                _candidates.splice(dragOverItem.current, 0, draggedItemContent);
                // update the actual array
                setDragItem(null);
                setDragOverItem(null);
                setCandidates(_candidates);
            };

            const [draggingIndex, setDraggingIndex] = React.useState(null);

            const onDragStart = (e, index) => {
                dragItem.current = index;
                setDraggingIndex(index);
                e.dataTransfer.effectAllowed = "move";
                // Create a ghost image if needed, or just let browser handle it
            };

            const onDragEnter = (e, index) => {
                dragOverItem.current = index;
                const list = [...candidates];
                // Visual feedback only (optional logic here)
            };

            const onDragEnd = (e) => {
                handleSort();
                setDraggingIndex(null);
            };

            const onDragOver = (e) => {
                e.preventDefault(); // Necessary to allow dropping
            }
            
            const setDragItem = (val) => dragItem.current = val;
            const setDragOverItem = (val) => dragOverItem.current = val;

            return (
                <div className="min-h-screen relative flex flex-col p-6 animate-fadeIn">
                    {bgUrl && <div className="absolute inset-0 z-0"><img src={bgUrl} className="w-full h-full object-cover opacity-30 blur-sm" /></div>}
                    
                    <header className="relative z-10 flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="flex items-center gap-4">
                            <div onClick={() => logoInputRef.current.click()} className="cursor-pointer group relative shrink-0">
                                {logoUrl ? <img src={logoUrl} className="h-16 w-auto object-contain drop-shadow-lg" /> : <div className="h-16 w-16 bg-white/10 rounded-lg flex items-center justify-center border-2 border-dashed border-white/30 text-white/50 text-xs">Logo</div>}
                                <input type="file" ref={logoInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" />
                            </div>
                            <div>
                                <h1 className="text-xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[#00c0fa] to-white">
                                    ระบบจัดลำดับผู้ร่วมดีเบต
                                </h1>
                                <p className="text-white/50 text-xs md:text-sm">เจียงใหม่ดีเบต เลือกตั้ง 69 (Backup & Config)</p>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-3 justify-center">
                            <button onClick={() => backupInputRef.current.click()} className="flex items-center gap-2 px-3 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-300 rounded-lg border border-green-500/30 transition text-sm">
                                <Icons.Upload /> กู้คืน/นำเข้า
                                <input type="file" ref={backupInputRef} onChange={handleImport} className="hidden" accept=".json" />
                            </button>
                            <button onClick={handleExport} className="flex items-center gap-2 px-3 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 rounded-lg border border-blue-500/30 transition text-sm">
                                <Icons.Save /> สำรองข้อมูล
                            </button>
                            <button onClick={() => bgInputRef.current.click()} className="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 transition text-sm"><Icons.Image /> เปลี่ยนพื้นหลัง <input type="file" ref={bgInputRef} onChange={handleBgUpload} className="hidden" accept="image/*" /></button>
                        </div>
                    </header>

                    <div className="relative z-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20 overflow-y-auto pr-2 no-scrollbar" style={{height: 'calc(100vh - 120px)'}}>
                        {candidates.map((c, index) => (
                            <div 
                                key={c.id} 
                                draggable
                                onDragStart={(e) => onDragStart(e, index)}
                                onDragEnter={(e) => onDragEnter(e, index)}
                                onDragEnd={onDragEnd}
                                onDragOver={onDragOver}
                                className={`bg-[#0f1020]/90 border rounded-xl p-4 flex flex-col gap-3 relative group transition duration-200 
                                    ${draggingIndex === index ? 'opacity-40 border-dashed border-[#00c0fa]' : 'border-white/10 hover:border-[#00c0fa]/50'}
                                `}
                            >
                                {/* Drag Handle */}
                                <div className="absolute top-2 left-2 p-1.5 text-white/30 hover:text-white cursor-grab active:cursor-grabbing z-20 drag-handle" title="ลากเพื่อย้ายตำแหน่ง">
                                    <Icons.Grip />
                                </div>

                                <button onClick={() => removeCandidate(c.id)} className="absolute top-2 right-2 p-1.5 bg-red-500/20 text-red-400 rounded-full hover:bg-red-500 hover:text-white transition z-20"><Icons.Trash /></button>
                                
                                <div className="flex gap-3 h-24 mt-4">
                                    <div className="relative w-24 h-24 bg-white rounded-lg overflow-hidden border border-white/10 shrink-0 cursor-pointer group-inner">
                                        {c.img ? <img src={c.img} className="w-full h-full object-contain" /> : <div className="w-full h-full bg-slate-200 flex items-center justify-center text-slate-400"><Icons.Upload /></div>}
                                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-inner-hover:opacity-100 transition text-xs text-white">เปลี่ยนรูป</div>
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={(e) => handleImageUpload(c.id, 'img', e.target.files[0])} />
                                    </div>
                                    <div className="flex flex-col justify-between flex-1 gap-2">
                                        <div className="flex gap-2 items-center">
                                            <div className="relative w-8 h-8 rounded overflow-hidden border border-white/20 shrink-0">
                                                    <input type="color" value={c.color} onChange={(e) => updateCandidate(c.id, 'color', e.target.value)} className="absolute -top-2 -left-2 w-12 h-12 p-0 border-0 cursor-pointer" />
                                            </div>
                                            <input type="text" value={c.color} onChange={(e) => updateCandidate(c.id, 'color', e.target.value)} className="w-full bg-black/30 border border-white/10 rounded px-2 py-1 text-sm text-white/80 focus:outline-none focus:border-[#00c0fa] uppercase font-mono tracking-wide" placeholder="#000000" maxLength={7} />
                                        </div>
                                        <div className="relative h-10 w-full bg-black/40 rounded border border-white/10 flex items-center justify-center cursor-pointer">
                                            {c.partyLogo ? <img src={c.partyLogo} className="h-full w-auto object-contain" /> : <span className="text-[10px] text-white/30">โลโก้พรรค</span>}
                                            <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={(e) => handleImageUpload(c.id, 'partyLogo', e.target.files[0])} />
                                        </div>
                                    </div>
                                </div>
                                <input type="text" value={c.name} onChange={(e) => updateCandidate(c.id, 'name', e.target.value)} placeholder="ชื่อผู้สมัคร..." className="bg-transparent border-b border-white/20 px-2 py-1 text-lg text-white focus:border-[#00c0fa] focus:outline-none placeholder-white/20" />
                                <input type="text" value={c.party} onChange={(e) => updateCandidate(c.id, 'party', e.target.value)} placeholder="ชื่อพรรค..." className="bg-transparent border-b border-white/20 px-2 py-1 text-sm text-[#00c0fa] focus:border-[#00c0fa] focus:outline-none placeholder-white/20" />
                            </div>
                        ))}
                        <button onClick={addCandidate} className="h-[250px] border-2 border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center text-white/30 hover:text-[#00c0fa] hover:border-[#00c0fa] hover:bg-[#00c0fa]/5 transition gap-2"><Icons.Plus /> เพิ่มผู้สมัคร</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
