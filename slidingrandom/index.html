<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสุ่มผู้สมัคร - เจียงใหม่ดีเบต เลือกตั้ง 69 (Final Adjusted)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@100;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #1e2542; 
            color: white;
            overflow: hidden;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.6s ease-out forwards; }
        
        @keyframes fadeInScene { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeInScene { animation: fadeInScene 0.5s ease-out forwards; }

        @keyframes popIn { 
            0% { opacity: 0; transform: scale(0.5); } 
            70% { transform: scale(1.05); } 
            100% { opacity: 1; transform: scale(1); } 
        }
        .animate-pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes popOut {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); }
        }
        .animate-pop-out { animation: popOut 0.4s ease-in forwards; }

        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }

        .flash-overlay {
            position: fixed; inset: 0;
            background: white;
            z-index: 10000; opacity: 0; pointer-events: none;
        }
        .flash-active { animation: flash 0.4s ease-out forwards; }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .carousel-mask {
            mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
        }

        .hardware-accelerated {
            will-change: transform;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        .carousel-container {
            contain: layout paint style; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const DB_NAME = 'CM108_Debate_System';
        const DB_VERSION = 1;
        const STORE_NAME = 'app_data';

        const dbHelper = {
            open: () => new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            }),
            save: async (key, data) => {
                try {
                    const db = await dbHelper.open();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).put(data, key);
                } catch (e) { console.error("DB Save Error", e); }
            },
            get: async (key) => {
                try {
                    const db = await dbHelper.open();
                    return new Promise((resolve) => {
                        const tx = db.transaction(STORE_NAME, 'readonly');
                        const request = tx.objectStore(STORE_NAME).get(key);
                        request.onsuccess = () => resolve(request.result);
                    });
                } catch (e) { return null; }
            }
        };

        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        };

        const formatCandidateName = (fullName) => {
            if (!fullName) return { firstName: '', lastName: '' };
            const parts = fullName.trim().split(/\s+/);
            const firstName = (parts[0] || '').replace(/\|/g, ' '); 
            const lastName = parts.slice(1).join(' ') || '';
            return { firstName, lastName };
        };

        const compressImage = (file, maxWidth = 500, quality = 0.7, format = 'image/jpeg', fillWhite = true) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                        else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        if (fillWhite) { ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, width, height); }
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL(format, quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const CARD_WIDTH = 300; 

        const CandidateCard = React.memo(({ c, index }) => {
            const { firstName, lastName } = formatCandidateName(c.name);
            return (
                <div className="shrink-0 flex flex-col items-center justify-center p-4 transition-opacity duration-300" style={{ width: `${CARD_WIDTH}px` }}>
                    <div className="flex flex-col items-center justify-center h-full w-full">
                        <div className="relative mb-4 shrink-0">
                            <div className="w-44 h-44 rounded-full overflow-hidden border-4 bg-white shadow-2xl flex items-center justify-center" 
                                    style={{ borderColor: c.color }}>
                                {c.img ? <img src={c.img} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-slate-200 flex items-center justify-center"><Icons.Image /></div>}
                            </div>
                            {c.partyLogo && (
                                <div className="absolute -bottom-1 -right-1 w-16 h-16 bg-white rounded-full border-2 shadow-lg flex items-center justify-center z-20 p-1 overflow-hidden" 
                                        style={{ borderColor: c.color }}>
                                    <img src={c.partyLogo} className="max-w-full max-h-full object-contain" />
                                </div>
                            )}
                        </div>
                        <div className="text-center drop-shadow-md w-full px-2 overflow-hidden">
                            <div className="text-3xl text-white font-medium leading-normal mb-0.15 truncate pt-2 pb-1">{firstName}</div>
                            <div className="text-2xl text-white font-medium truncate pt-1">{lastName || '-'}</div>
                        </div>
                        <div className="mt-2 px-5 py-1.5 rounded-full bg-black/40 border-2 w-fit max-w-[240px] shadow-lg" style={{ borderColor: c.color }}>
                            <p className="text-sm font-light text-white truncate">{c.party}</p>
                        </div>
                    </div>
                </div>
            );
        });

        const App = () => {
            const [view, setView] = React.useState('input'); 
            const [candidates, setCandidates] = React.useState([]);
            const [winner, setWinner] = React.useState(null);
            const [history, setHistory] = React.useState([]); 
            const [finalAnim, setFinalAnim] = React.useState(false); 
            const [isExiting, setIsExiting] = React.useState(false); 
            const [dataLoaded, setDataLoaded] = React.useState(false);
            
            const remainingCandidates = React.useMemo(() => {
                return candidates.filter(c => !history.some(h => h.id === c.id));
            }, [candidates, history]);

            const [displayPool, setDisplayPool] = React.useState([]); 
            const carouselRef = React.useRef(null);
            const positionRef = React.useRef(0);
            const speedRef = React.useRef(0);
            const animationRef = React.useRef(null);
            const stateRef = React.useRef('idle'); 
            
            // --- ADJUSTMENT 1: Slower Stop (Increased Friction) ---
            const frictionRef = React.useRef(0.985); // ปรับจาก 0.980 เป็น 0.985 ให้ไถลนานขึ้น

            const [logoUrl, setLogoUrl] = React.useState(null);
            const [bgUrl, setBgUrl] = React.useState(null);

            const logoInputRef = React.useRef(null);
            const bgInputRef = React.useRef(null);
            const backupInputRef = React.useRef(null);
            
            const cursorTimeout = React.useRef(null);

            React.useEffect(() => {
                const handleActivity = () => {
                    document.body.style.cursor = 'auto';
                    if (cursorTimeout.current) clearTimeout(cursorTimeout.current);
                    cursorTimeout.current = setTimeout(() => {
                        document.body.style.cursor = 'none';
                    }, 3000);
                };
                window.addEventListener('mousemove', handleActivity);
                window.addEventListener('keydown', handleActivity);
                window.addEventListener('click', handleActivity);
                handleActivity();
                return () => {
                    window.removeEventListener('mousemove', handleActivity);
                    window.removeEventListener('keydown', handleActivity);
                    window.removeEventListener('click', handleActivity);
                    if (cursorTimeout.current) clearTimeout(cursorTimeout.current);
                };
            }, []);

            React.useEffect(() => {
                const loadData = async () => {
                    try {
                        const savedCandidates = await dbHelper.get('candidates') || [];
                        const savedLogo = await dbHelper.get('logo');
                        const savedBg = await dbHelper.get('bg');
                        if (savedCandidates.length === 0) {
                             const localCand = localStorage.getItem('cm108_candidates');
                             if (localCand) setCandidates(JSON.parse(localCand));
                        } else {
                             setCandidates(savedCandidates);
                        }
                        if (savedLogo) setLogoUrl(savedLogo);
                        if (savedBg) setBgUrl(savedBg);
                        setDataLoaded(true);
                    } catch (err) { setDataLoaded(true); }
                };
                loadData();
            }, []);

            React.useEffect(() => {
                if (dataLoaded) {
                    dbHelper.save('candidates', candidates);
                    try { localStorage.setItem('cm108_candidates', JSON.stringify(candidates)); } catch(e){}
                }
            }, [candidates, dataLoaded]);

            React.useEffect(() => {
                if (view === 'finished') {
                    const timer = setTimeout(() => { setFinalAnim(true); }, 1000);
                    return () => clearTimeout(timer);
                } else { setFinalAnim(false); }
            }, [view]);

            const handleLogoUpload = async (e) => {
                if (e.target.files[0]) {
                    try {
                        const compressed = await compressImage(e.target.files[0], 400, 0.8, 'image/png', false); 
                        setLogoUrl(compressed); dbHelper.save('logo', compressed);
                    } catch (error) {}
                }
            };
            const handleBgUpload = async (e) => {
                if (e.target.files[0]) {
                    try {
                        const compressed = await compressImage(e.target.files[0], 1024, 0.7, 'image/jpeg', true);
                        setBgUrl(compressed); dbHelper.save('bg', compressed);
                    } catch (error) {}
                }
            };
            const addCandidate = () => setCandidates([...candidates, { id: Date.now(), name: '', party: '', color: '#00c0fa', img: null, partyLogo: null }]);
            const updateCandidate = (id, field, value) => setCandidates(candidates.map(c => c.id === id ? { ...c, [field]: value } : c));
            const removeCandidate = (id) => setCandidates(candidates.filter(c => c.id !== id));
            const handleImageUpload = async (id, field, file) => {
                if (file) {
                    try {
                        const isPartyLogo = field === 'partyLogo';
                        const compressed = await compressImage(file, 500, 0.7, isPartyLogo ? 'image/png' : 'image/jpeg', !isPartyLogo);
                        updateCandidate(id, field, compressed);
                    } catch (error) {}
                }
            };

            const handleExport = () => {
                const data = { candidates, logoUrl, bgUrl };
                const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `cm108_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.candidates) setCandidates(data.candidates);
                        if (data.logoUrl) { setLogoUrl(data.logoUrl); dbHelper.save('logo', data.logoUrl); }
                        if (data.bgUrl) { setBgUrl(data.bgUrl); dbHelper.save('bg', data.bgUrl); }
                        alert("กู้คืนข้อมูลสำเร็จ!");
                    } catch (err) { alert("ไฟล์ไม่ถูกต้อง"); }
                };
                reader.readAsText(file);
            };

            const CLONE_MULTIPLIER = 16;
            
            const buildDisplayPool = (list) => {
                if (list.length === 0) return [];
                let expanded = [];
                for(let i=0; i<CLONE_MULTIPLIER; i++) expanded.push(...list);
                return expanded;
            };

            const startSystem = () => {
                if (candidates.length === 0) return;
                const pool = buildDisplayPool(candidates);
                setDisplayPool(pool);
                setHistory([]);
                const centerSetIndex = Math.floor(CLONE_MULTIPLIER / 2);
                positionRef.current = centerSetIndex * candidates.length * CARD_WIDTH;
                stateRef.current = 'idle';
                setWinner(null);
                setView('ready');
            };

            const animateCarousel = () => {
                if (!carouselRef.current || stateRef.current === 'decided') return;
                
                positionRef.current += speedRef.current;
                
                const poolLength = displayPool.length;
                if (poolLength === 0) return;
                
                const setWidth = (poolLength / CLONE_MULTIPLIER) * CARD_WIDTH; 

                if (positionRef.current >= setWidth * (CLONE_MULTIPLIER - 4)) {
                    positionRef.current -= setWidth * (CLONE_MULTIPLIER - 8); 
                }
                if (positionRef.current <= setWidth * 2) {
                    positionRef.current += setWidth * (CLONE_MULTIPLIER - 8);
                }

                const centerOffset = window.innerWidth / 2 - (CARD_WIDTH / 2);
                const transformX = centerOffset - positionRef.current;
                
                carouselRef.current.style.transform = `translate3d(${transformX}px, 0, 0)`;

                if (stateRef.current === 'stopping') {
                    speedRef.current *= frictionRef.current; 
                    if (speedRef.current < 0.8) { 
                        stateRef.current = 'snapping';
                    }
                }

                if (stateRef.current === 'snapping') {
                    const currentIndex = Math.round(positionRef.current / CARD_WIDTH);
                    let targetIndex = currentIndex;
                    let foundValid = false;

                    const searchRange = Math.min(20, displayPool.length / 2);

                    for (let offset = 0; offset < searchRange; offset++) {
                        const checkIndices = [currentIndex + offset, currentIndex - offset];
                        for (let idx of checkIndices) {
                            const item = displayPool[idx];
                            if (item && !history.some(h => h.id === item.id)) {
                                targetIndex = idx;
                                foundValid = true;
                                break;
                            }
                        }
                        if (foundValid) break;
                    }

                    const targetPos = targetIndex * CARD_WIDTH;
                    const diff = targetPos - positionRef.current;
                    
                    positionRef.current += diff * 0.05; 
                    speedRef.current *= 0.90; 

                    if (Math.abs(diff) < 0.2 && Math.abs(speedRef.current) < 0.1) {
                        positionRef.current = targetPos;
                        carouselRef.current.style.transform = `translate3d(${centerOffset - targetPos}px, 0, 0)`;
                        
                        const finalWinner = displayPool[targetIndex];
                        const winnerToSet = finalWinner || remainingCandidates[0];
                        
                        if (winnerToSet) {
                            stateRef.current = 'decided';
                            setWinner(winnerToSet);
                            // --- ADJUSTMENT 2: Faster Reveal ---
                            setTimeout(() => setView('winner'), 50); // ปรับจาก 400ms เหลือ 50ms ให้โชว์ทันที
                        } else {
                             setView('finished');
                        }
                        return;
                    }
                }
                animationRef.current = requestAnimationFrame(animateCarousel);
            };

            const startSpin = () => {
                const remaining = remainingCandidates;
                if (remaining.length === 0) { setView('finished'); return; }
                if (remaining.length === 1) { setWinner(remaining[0]); setView('winner'); return; }

                if (animationRef.current) cancelAnimationFrame(animationRef.current);
                stateRef.current = 'spinning';
                setView('spinning');
                speedRef.current = 0; 
                
                const accelerate = () => {
                    const accelRate = 2.5 + Math.random();
                    if (stateRef.current === 'spinning' && speedRef.current < 60) { 
                        speedRef.current += accelRate; 
                        requestAnimationFrame(accelerate);
                    }
                };
                accelerate();
                animateCarousel();
            };

            const stopSpin = () => { 
                if (stateRef.current !== 'spinning') return;
                stateRef.current = 'stopping'; 
                // --- ADJUSTMENT 1: Reset Friction ---
                frictionRef.current = 0.985; 
            };

            const resetRound = () => {
                if (winner && !isExiting) {
                    setIsExiting(true); 
                    setTimeout(() => {
                        const newHistory = [...history, winner];
                        setHistory(newHistory);
                        const nextRemaining = candidates.filter(c => !newHistory.some(h => h.id === c.id));
                        
                        if (nextRemaining.length === 0) {
                            setView('finished');
                        } else {
                            const newPool = buildDisplayPool(nextRemaining);
                            const currentIndex = Math.round(positionRef.current / CARD_WIDTH);
                            const listSizeBefore = remainingCandidates.length;
                            const listSizeAfter = nextRemaining.length;
                            if (listSizeAfter > 0) {
                                const cycleIndex = currentIndex % listSizeBefore;
                                const newBaseIndex = Math.floor(currentIndex / listSizeBefore) * listSizeAfter;
                                positionRef.current = (newBaseIndex + (cycleIndex % listSizeAfter)) * CARD_WIDTH;
                            }
                            setDisplayPool(newPool);
                            setWinner(null);
                            stateRef.current = 'idle';
                            setView('ready');
                        }
                        setIsExiting(false);
                    }, 500); 
                }
            };

            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    if (view === 'input') return;
                    if (e.key === 'Enter' || e.code === 'Space') {
                        e.preventDefault();
                        if (e.repeat) return; 
                        if (view === 'ready' && stateRef.current === 'idle') {
                            startSpin();
                        } else if (view === 'spinning' && stateRef.current === 'spinning') {
                            stopSpin();
                        }
                    } else if (e.key === 'Escape') {
                        if (view === 'winner') resetRound();
                        else if (view === 'finished') setView('input');
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [view, displayPool, history, winner, remainingCandidates, isExiting]);

            const GameBackground = () => (
                <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden" style={{contain: 'strict'}}>
                    {bgUrl ? (
                        <div className="absolute inset-0">
                            <img src={bgUrl} className="w-full h-full object-cover blur-sm opacity-60" />
                            <div className="absolute inset-0 bg-[#1e2542]/80 mix-blend-multiply"></div>
                        </div>
                    ) : <div className="absolute inset-0 bg-gradient-to-br from-[#0f172a] via-[#1e2542] to-[#312e81]"></div>}
                    <div className="absolute -top-[10%] -left-[10%] w-[60vw] h-[60vw] bg-[#00c0fa]/20 blur-[80px] rounded-full mix-blend-screen opacity-60"></div>
                    <div className="absolute -top-[10%] -right-[10%] w-[60vw] h-[60vw] bg-[#a855f7]/20 blur-[80px] rounded-full mix-blend-screen opacity-60"></div>
                </div>
            );

            const TopRightLink = () => (
                <div onClick={() => setView('input')} className="fixed top-6 right-8 z-[100] text-white/50 font-medium text-lg cursor-pointer hover:text-[#00c0fa] transition drop-shadow-md">
                    CM108 x MCOT x สวท.เชียงใหม่
                </div>
            );

            if (view === 'input') {
                return (
                    <div className="min-h-screen relative flex flex-col p-6 animate-fadeIn">
                        {bgUrl && <div className="absolute inset-0 z-0"><img src={bgUrl} className="w-full h-full object-cover opacity-30 blur-sm" /></div>}
                        <header className="relative z-10 flex justify-between items-center mb-6">
                            <div className="flex items-center gap-4">
                                <div onClick={() => logoInputRef.current.click()} className="cursor-pointer group relative">
                                    {logoUrl ? <img src={logoUrl} className="h-16 w-auto object-contain drop-shadow-lg" /> : <div className="h-16 w-16 bg-white/10 rounded-lg flex items-center justify-center border-2 border-dashed border-white/30 text-white/50 text-xs">Logo</div>}
                                    <input type="file" ref={logoInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" />
                                </div>
                                <h1 className="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[#00c0fa] to-white py-2">
                                    "เจียงใหม่ดีเบต เลือกตั้ง 69"
                                </h1>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => backupInputRef.current.click()} className="flex items-center gap-2 px-3 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-300 rounded-lg border border-green-500/30 transition text-sm">
                                    <Icons.Upload /> กู้คืน
                                    <input type="file" ref={backupInputRef} onChange={handleImport} className="hidden" accept=".json" />
                                </button>
                                <button onClick={handleExport} className="flex items-center gap-2 px-3 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 rounded-lg border border-blue-500/30 transition text-sm">
                                    <Icons.Plus /> สำรอง
                                </button>
                                <button onClick={() => bgInputRef.current.click()} className="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 transition"><Icons.Image /> พื้นหลัง <input type="file" ref={bgInputRef} onChange={handleBgUpload} className="hidden" accept="image/*" /></button>
                                <button onClick={startSystem} className="flex items-center gap-2 px-6 py-2 bg-[#00c0fa] hover:bg-[#0090c0] text-black font-bold rounded-lg shadow-lg transition transform hover:scale-105"><Icons.Play /> เริ่มระบบสุ่ม</button>
                            </div>
                        </header>
                        <div className="relative z-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20 overflow-y-auto pr-2 no-scrollbar" style={{height: 'calc(100vh - 120px)'}}>
                            {candidates.map((c) => (
                                <div key={c.id} className="bg-[#0f1020]/80 border border-white/10 rounded-xl p-4 flex flex-col gap-3 relative group hover:border-[#00c0fa]/50 transition">
                                    <button onClick={() => removeCandidate(c.id)} className="absolute top-2 right-2 p-1.5 bg-red-500/20 text-red-400 rounded-full hover:bg-red-500 hover:text-white transition z-20"><Icons.Trash /></button>
                                    <div className="flex gap-3 h-24">
                                        <div className="relative w-24 h-24 bg-white rounded-lg overflow-hidden border border-white/10 shrink-0 cursor-pointer">
                                            {c.img ? <img src={c.img} className="w-full h-full object-contain" /> : <div className="w-full h-full bg-slate-200 flex items-center justify-center text-slate-400"><Icons.Upload /></div>}
                                            <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={(e) => handleImageUpload(c.id, 'img', e.target.files[0])} />
                                        </div>
                                        <div className="flex flex-col justify-between flex-1 gap-2">
                                            <div className="flex gap-2 items-center">
                                                <div className="relative w-8 h-8 rounded overflow-hidden border border-white/20 shrink-0">
                                                     <input type="color" value={c.color} onChange={(e) => updateCandidate(c.id, 'color', e.target.value)} className="absolute -top-2 -left-2 w-12 h-12 p-0 border-0 cursor-pointer" />
                                                </div>
                                                <input type="text" value={c.color} onChange={(e) => updateCandidate(c.id, 'color', e.target.value)} className="w-full bg-black/30 border border-white/10 rounded px-2 py-1 text-sm text-white/80 focus:outline-none focus:border-[#00c0fa] uppercase font-mono tracking-wide" placeholder="#000000" maxLength={7} />
                                            </div>
                                            <div className="relative h-10 w-full bg-black/40 rounded border border-white/10 flex items-center justify-center cursor-pointer">
                                                {c.partyLogo ? <img src={c.partyLogo} className="h-full w-auto object-contain" /> : <span className="text-[10px] text-white/30">โลโก้พรรค</span>}
                                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={(e) => handleImageUpload(c.id, 'partyLogo', e.target.files[0])} />
                                            </div>
                                        </div>
                                    </div>
                                    <input type="text" value={c.name} onChange={(e) => updateCandidate(c.id, 'name', e.target.value)} placeholder="ชื่อผู้สมัคร..." className="bg-transparent border-b border-white/20 px-2 py-1 text-lg text-white focus:border-[#00c0fa] focus:outline-none placeholder-white/20" />
                                    <input type="text" value={c.party} onChange={(e) => updateCandidate(c.id, 'party', e.target.value)} placeholder="ชื่อพรรค..." className="bg-transparent border-b border-white/20 px-2 py-1 text-sm text-[#00c0fa] focus:border-[#00c0fa] focus:outline-none placeholder-white/20" />
                                </div>
                            ))}
                            <button onClick={addCandidate} className="h-[230px] border-2 border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center text-white/30 hover:text-[#00c0fa] hover:border-[#00c0fa] hover:bg-[#00c0fa]/5 transition gap-2"><Icons.Plus /> เพิ่มผู้สมัคร</button>
                        </div>
                    </div>
                );
            }

            if (view === 'winner' && winner) {
                const { firstName, lastName } = formatCandidateName(winner.name);
                return (
                    <div className={`h-screen w-full relative overflow-hidden flex flex-col items-center justify-center px-4 ${isExiting ? 'animate-pop-out' : 'animate-pop-in'}`}>
                        <div className="flash-overlay flash-active"></div>
                        <GameBackground /><TopRightLink />
                        <div className="relative z-20 flex flex-col items-center w-full max-w-4xl">
                            <div className="relative w-64 h-64 md:w-80 md:h-80 mb-6 shrink-0">
                                <div className="absolute -inset-6 rounded-full animate-spin-slow opacity-90 blur-3xl" style={{ background: `conic-gradient(from 0deg, transparent, ${winner.color}, ${winner.color}, transparent, ${winner.color}, transparent)` }}></div>
                                <div className="absolute -inset-2 rounded-full animate-spin-slow opacity-100 blur-md" style={{ background: `conic-gradient(from 180deg, transparent, white, ${winner.color}, transparent, white, transparent)` }}></div>
                                <div className="absolute inset-0 bg-white rounded-full overflow-hidden border-4 shadow-[0_0_80px_rgba(255,255,255,0.3)] z-10" style={{ borderColor: winner.color }}>
                                    {winner.img ? <img src={winner.img} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-slate-200 flex items-center justify-center"><Icons.Image /></div>}
                                </div>
                                {winner.partyLogo && (
                                    <div className="absolute -bottom-4 -right-4 w-24 h-24 md:w-32 md:h-32 bg-white rounded-full border-4 shadow-[0_10px_40px_rgba(0,0,0,0.5)] z-30 p-2 overflow-hidden flex items-center justify-center" style={{ borderColor: winner.color }}>
                                        <img src={winner.partyLogo} className="max-w-full max-h-full object-contain" />
                                    </div>
                                )}
                            </div>
                            <div className="text-center drop-shadow-[0_4px_10px_rgba(0,0,0,0.8)] w-full mt-6">
                                <h1 className="text-4xl md:text-7xl font-black text-white leading-normal drop-shadow-lg">{firstName}</h1>
                                {lastName && <h1 className="text-3xl md:text-5xl font-bold text-white/90 break-words max-w-full leading-normal text-center mt-6">{lastName}</h1>}
                                <div className="inline-block mt-8 px-12 py-3 rounded-full bg-black/40 border-4 shadow-2xl backdrop-blur-md" style={{ borderColor: winner.color }}>
                                    <h2 className="text-3xl md:text-4xl font-light text-white">{winner.party}</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'finished') {
                const count = history.length;
                let gridCols, imgSize, badgeSize, badgeText, nameSize, surnameSize, partySize;
                if (count <= 4) { gridCols = "grid-cols-2 lg:grid-cols-4"; imgSize = "w-32 h-32 lg:w-44 lg:h-44"; badgeSize = "w-12 h-12 lg:w-16 lg:h-16"; badgeText = "text-2xl lg:text-3xl"; nameSize = "text-xl lg:text-2xl"; surnameSize = "text-lg lg:text-xl"; partySize = "text-sm lg:text-base"; } 
                else if (count <= 12) { gridCols = "grid-cols-3 lg:grid-cols-6"; imgSize = "w-24 h-24 lg:w-28 lg:h-28"; badgeSize = "w-10 h-10 lg:w-12 lg:h-12"; badgeText = "text-xl lg:text-2xl"; nameSize = "text-base lg:text-lg"; surnameSize = "text-sm lg:text-base"; partySize = "text-[10px] lg:text-xs"; } 
                else if (count <= 24) { gridCols = "grid-cols-4 lg:grid-cols-8"; imgSize = "w-16 h-16 lg:w-20 lg:h-20"; badgeSize = "w-8 h-8 lg:w-9 lg:h-9"; badgeText = "text-sm lg:text-base"; nameSize = "text-sm lg:text-base"; surnameSize = "text-[11px] lg:text-xs"; partySize = "text-[9px] lg:text-[10px]"; } 
                else { gridCols = "grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-12"; imgSize = "w-12 h-12 lg:w-14 lg:h-14"; badgeSize = "w-6 h-6 lg:w-7 lg:h-7"; badgeText = "text-[10px] lg:text-[12px]"; nameSize = "text-[10px] lg:text-[11px]"; surnameSize = "text-[8px] lg:text-[9px]"; partySize = "text-[7px] lg:text-[8px]"; }

                return (
                    <div className="h-screen w-full relative flex flex-col items-center overflow-hidden">
                        <GameBackground />
                        <div className={`transition-all duration-1000 ease-in-out fixed z-[100] flex justify-center items-center pointer-events-none ${finalAnim ? 'top-2 left-6 scale-[0.25] origin-top-left' : 'top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-100'}`}>
                             {logoUrl && <img src={logoUrl} className="w-auto h-[40vh] object-contain drop-shadow-[0_0_50px_rgba(0,192,250,0.8)]" alt="Logo" />}
                        </div>
                        <div className={`fixed top-8 left-1/2 -translate-x-1/2 z-[90] transition-all duration-1000 delay-700 pointer-events-none text-center ${finalAnim ? 'opacity-100' : 'opacity-0'}`}>
                            <h1 className="text-2xl md:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[#00c0fa] to-white py-2 pl-24">"เจียงใหม่ดีเบต เลือกตั้ง 69"</h1>
                        </div>
                        <div className={`mt-[18vh] w-full max-w-[98vw] px-4 z-10 transition-all duration-1000 delay-700 flex flex-col items-center justify-start overflow-y-auto no-scrollbar ${finalAnim ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'}`} style={{height: 'calc(100vh - 20vh)'}}>
                            <div className={`grid ${gridCols} gap-x-2 gap-y-6 lg:gap-x-4 lg:gap-y-8 w-full pb-20 px-2`}>
                                {history.map((h, i) => {
                                    const { firstName, lastName } = formatCandidateName(h.name);
                                    return (
                                        <div key={i} className="bg-[#0f1429]/80 backdrop-blur-md rounded-2xl p-2 flex flex-col items-center text-center border border-white/10 shadow-xl animate-fadeIn transform transition-all hover:scale-105" style={{animationDelay: `${i*0.04}s`}}>
                                            <div className="relative mb-2">
                                                <div className={`${imgSize} rounded-full bg-white overflow-hidden border-2 shrink-0 shadow-lg`} style={{ borderColor: h.color }}>{h.img ? <img src={h.img} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-slate-200" />}</div>
                                                <div className={`absolute -bottom-1 -right-1 ${badgeSize} rounded-full bg-[#00c0fa] border-2 border-[#1e2542] flex items-center justify-center shadow-lg`}><span className={`${badgeText} font-bold text-[#1e2542]`}>{i+1}</span></div>
                                            </div>
                                            <div className="w-full overflow-hidden leading-tight font-normal mt-1"><div className={`${nameSize} text-white truncate px-1`}>{firstName}</div><div className={`${surnameSize} text-white/50 truncate px-1`}>{lastName || '-'}</div></div>
                                            <div className="mt-2 w-full"><div className={`${partySize} py-0.5 px-2 rounded-full bg-white/5 text-[#00c0fa] truncate block w-full border border-white/30 font-light`} style={{ borderColor: h.color }}>{h.party}</div></div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`h-screen w-full relative flex flex-col items-center justify-center overflow-hidden ${isExiting ? 'animate-fadeInScene' : ''}`}>
                    <GameBackground /><TopRightLink />
                    <div className="absolute top-2 left-6 z-[60] pointer-events-none transition-all duration-700">
                         <div className="w-[100px] h-[100px] md:w-[140px] md:h-[140px] flex items-center justify-center">
                              <img src={logoUrl} className="max-w-full max-h-full object-contain drop-shadow-[0_0_20px_rgba(0,192,250,0.7)]" />
                         </div>
                    </div>
                    <div className="absolute inset-0 pointer-events-none flex items-center justify-center z-20">
                         <div className="relative w-[300px] h-[400px] flex items-center justify-center">
                            <div className="absolute -top-16 left-0 right-0 flex justify-center">
                                <div className="text-[#00c0fa] animate-bounce drop-shadow-[0_0_15px_rgba(0,192,250,1)]">
                                     <svg width="70" height="70" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21l-12-18h24z"/></svg>
                                </div>
                            </div>
                            <div className={`w-full h-full border-4 rounded-3xl transition-all duration-300 ${stateRef.current !== 'idle' ? 'border-[#00c0fa] shadow-[0_0_50px_rgba(0,192,250,0.5)] scale-105' : 'border-white/20'}`}></div>
                         </div>
                    </div>
                    <div className="w-full h-[450px] flex items-center overflow-hidden relative z-10 carousel-mask mt-12 carousel-container">
                        <div ref={carouselRef} className="flex items-center absolute left-0 hardware-accelerated" style={{ height: '100%', transform: `translate3d(${window.innerWidth/2 - CARD_WIDTH/2 - positionRef.current}px, 0, 0)` }}>
                            {displayPool.length > 0 && displayPool.map((c, index) => (
                                <CandidateCard key={`${c.id}-${index}`} c={c} index={index} />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
