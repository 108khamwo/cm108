<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เจียงใหม่ดีเบต เลือกตั้ง 69 (Final Delay)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #1e2542; 
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        body.game-mode {
            cursor: none !important;
        }
        body.game-mode * {
            cursor: none !important;
        }

        .perspective-1000 {
            perspective: 1000px;
        }

        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.95); filter: blur(4px); }
            100% { opacity: 1; transform: scale(1); filter: blur(0); }
        }
        .animate-page-enter {
            animation: fadeInScale 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 4s linear infinite;
        }

        .flash-overlay {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 10000; 
            opacity: 0;
            pointer-events: none;
        }
        .flash-overlay.flash-trigger {
            animation: flashEffect 0.5s ease-out forwards;
        }

        @keyframes flashEffect {
            0% { opacity: 0.8; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body> 
    <div id="root"></div>

    <script type="text/babel">
        const Icons = {
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            UploadCloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
        };

        const compressImage = (file, maxWidth = 1024) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const elem = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        elem.width = width;
                        elem.height = height;
                        const ctx = elem.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const mimeType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                        const quality = mimeType === 'image/jpeg' ? 0.7 : undefined;
                        resolve(elem.toDataURL(mimeType, quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const CardItem = React.memo(({ 
            idx, isHighlighted, isAutoRandomizing, isStopping, openCard, setHighlightedCard, 
            totalCards 
        }) => {
            
            const numberSizeClass = totalCards > 6 
                ? "text-5xl" 
                : "text-6xl md:text-8xl lg:text-[9rem]"; 

            const activeStyle = isHighlighted 
                ? "border-white bg-slate-800 scale-105 shadow-[0_0_60px_rgba(0,192,250,0.8),0_0_30px_rgba(168,85,247,0.6)] z-20 ring-4 ring-white/20"
                : "border-white/10 hover:border-[#00c0fa]/50 hover:bg-slate-800/80 hover:scale-[1.02] hover:shadow-[0_0_30px_rgba(0,192,250,0.3)] hover:z-10";

            const transitionClass = isAutoRandomizing 
                ? (isStopping ? 'duration-500 ease-out' : 'duration-100 ease-linear')
                : 'duration-300 ease-in-out';

            return (
                <div 
                    className={`
                        relative flex-1 h-full min-h-0 min-w-0
                        transition-all ${transitionClass}
                        flex flex-col items-center justify-center
                        group perspective-1000
                        p-1
                        pointer-events-none 
                        ${isAutoRandomizing ? '' : ''}
                    `}
                >
                    <div className={`
                        w-full h-full rounded-2xl border-2 
                        flex flex-col items-center justify-center
                        transition-all duration-300 relative overflow-hidden
                        backdrop-blur-md bg-slate-900/40
                        ${activeStyle}
                    `}>
                        <div className={`absolute inset-0 bg-gradient-to-br from-[#00c0fa]/0 via-[#00c0fa]/0 to-[#a855f7]/0 transition-opacity duration-300 ${isHighlighted ? 'opacity-60 via-[#00c0fa]/40' : 'group-hover:opacity-20'}`}></div>

                        <div className={`text-white text-xl md:text-3xl font-bold tracking-wide mb-4 md:mb-8 uppercase transition-colors ${isHighlighted ? 'drop-shadow-[0_0_15px_rgba(255,255,255,1)]' : 'opacity-90'}`}>
                            คำถามหมายเลข
                        </div>

                        <div className={`
                            relative rounded-full aspect-square
                            flex items-center justify-center
                            transition-all duration-500
                            bg-white/5 border border-white/10
                            ${totalCards <= 5 ? 'h-28 md:h-40 lg:h-56' : 'h-20 md:h-28'} 
                            ${isHighlighted 
                                ? 'scale-110 bg-[#00c0fa] border-white border-4 shadow-[0_0_60px_rgba(255,255,255,0.8)]' 
                                : 'scale-100 group-hover:scale-110 group-hover:bg-[#00c0fa]/20 group-hover:border-[#00c0fa] group-hover:shadow-[0_0_50px_rgba(0,192,250,0.8)]'
                            }
                        `}>
                            <div className={`absolute inset-0 rounded-full bg-white/5 border border-white/10 transition-colors 
                                group-hover:border-[#00c0fa]/50 ${isHighlighted ? 'border-white' : ''}`}></div>

                            <div className={`absolute -inset-1 rounded-full bg-gradient-to-tr from-transparent via-[#00c0fa] via-50% to-transparent opacity-80 blur-sm animate-spin-slow transition-opacity duration-300
                                ${isHighlighted ? 'opacity-100 mix-blend-screen' : 'opacity-0 group-hover:opacity-100'}`}></div>

                            <div className={`absolute -inset-1 rounded-full bg-gradient-to-bl from-transparent via-purple-500 to-transparent opacity-30 blur-sm animate-spin-slow transition-opacity duration-300
                                ${isHighlighted ? 'opacity-0' : 'opacity-0 group-hover:opacity-50'}`}></div>
                            
                            <div className={`absolute inset-1 rounded-full bg-slate-900/80 flex items-center justify-center backdrop-blur-sm border border-white/10 transition-colors 
                                group-hover:border-[#00c0fa] ${isHighlighted ? 'border-transparent bg-[#00c0fa]' : ''}`}>
                                <span className={`font-bold text-white drop-shadow-[0_0_15px_rgba(0,192,250,0.9)] z-20 ${numberSizeClass}`}>
                                    {idx + 1}
                                </span>
                            </div>
                        </div>

                    </div>
                </div>
            );
        });

        const App = () => {
            const [gameState, setGameState] = React.useState('input'); 
            const [questions, setQuestions] = React.useState([]);
            
            const [inputText, setInputText] = React.useState(() => {
                const saved = localStorage.getItem('debate_questions_v6');
                // Fallback to V5 if V6 is empty
                const savedV5 = localStorage.getItem('debate_questions_v5');
                return saved || savedV5 || `นโยบายเร่งด่วน 100 วันแรก?
แนวทางแก้ปัญหาเศรษฐกิจ?
จุดยืนเรื่องความเท่าเทียม?
การจัดการปัญหาฝุ่น PM 2.5?
วิสัยทัศน์การศึกษาไทย?`;
            });

            const [activeCardIndex, setActiveCardIndex] = React.useState(null); 
            const [highlightedCard, setHighlightedCard] = React.useState(null); 
            const [recentHistory, setRecentHistory] = React.useState([]); 

            const [isAutoRandomizing, setIsAutoRandomizing] = React.useState(false);
            const [isStopping, setIsStopping] = React.useState(false); 

            const randomizerRef = React.useRef(null);
            const speedRef = React.useRef(80); 
            const stoppingRef = React.useRef(false); 
            const lastEscPressRef = React.useRef(0); 

            // Variable for balanced randomization
            const usageRef = React.useRef([]);
            const stoppingStepsTotalRef = React.useRef(0);
            const stoppingStepsRemainingRef = React.useRef(0);
            const targetIndexRef = React.useRef(-1);

            const inputBufferRef = React.useRef('');
            const inputTimeoutRef = React.useRef(null);

            const [logoUrl, setLogoUrl] = React.useState(() => {
                try { return localStorage.getItem('debate_logo') || 'logo_debate.png'; } catch (e) { return 'logo_debate.png'; }
            });
            const [bgUrl, setBgUrl] = React.useState(() => {
                try { return localStorage.getItem('debate_bg') || null; } catch (e) { return null; }
            });
            
            const fileInputRef = React.useRef(null);
            const bgInputRef = React.useRef(null);
            const importInputRef = React.useRef(null);
            const flashRef = React.useRef(null);

            React.useEffect(() => {
                localStorage.setItem('debate_questions_v6', inputText);
            }, [inputText]);

            React.useEffect(() => {
                if (gameState === 'playing') {
                    document.body.classList.add('game-mode');
                } else {
                    document.body.classList.remove('game-mode');
                }
            }, [gameState]);

            React.useEffect(() => {
                const handleKeyInput = (e) => {
                    if (gameState !== 'playing') return;

                    if (e.key === 'Escape') {
                        const now = Date.now();
                        if (now - lastEscPressRef.current < 500) { 
                            resetGame();
                            return;
                        }
                        lastEscPressRef.current = now;

                        if (activeCardIndex !== null) {
                            closeCard();
                        }
                        return;
                    }

                    if (activeCardIndex !== null) {
                        if (e.key === 'Enter' || e.code === 'Space') {
                            closeCard();
                        }
                        return;
                    }

                    if (e.code === 'Space' && activeCardIndex === null) {
                        e.preventDefault(); 
                        toggleRandomizer();
                        return;
                    }

                    if (/^\d$/.test(e.key) && !isAutoRandomizing) {
                        if (inputTimeoutRef.current) clearTimeout(inputTimeoutRef.current);
                        inputBufferRef.current += e.key;
                        
                        inputTimeoutRef.current = setTimeout(() => {
                            const num = parseInt(inputBufferRef.current, 10);
                            const index = num - 1; 
                            
                            if (index >= 0 && index < questions.length) {
                                setHighlightedCard(index);
                            } else {
                                setHighlightedCard(null);
                            }
                            inputBufferRef.current = '';
                        }, 1000); 
                    } 
                    else if (e.key === 'Enter') {
                        if (highlightedCard !== null && !isAutoRandomizing) {
                            openCard(highlightedCard); 
                        }
                    }
                };

                window.addEventListener('keydown', handleKeyInput);
                return () => {
                    window.removeEventListener('keydown', handleKeyInput);
                    if (inputTimeoutRef.current) clearTimeout(inputTimeoutRef.current);
                };
            }, [gameState, activeCardIndex, isAutoRandomizing, highlightedCard, questions]); 

            const handleStart = () => {
                const qList = inputText.split('\n').map(q => q.trim()).filter(q => q.length > 0);
                if (qList.length === 0) {
                    alert('กรุณาใส่คำถามอย่างน้อย 1 ข้อ');
                    return;
                }
                setQuestions(qList);
                // Initialize usage counts
                usageRef.current = new Array(qList.length).fill(0);
                setGameState('playing');
            };

            const openCard = (index) => {
                if(flashRef.current) {
                    flashRef.current.classList.add('flash-trigger');
                    setTimeout(() => flashRef.current.classList.remove('flash-trigger'), 500);
                }
                
                // Update usage count when card is successfully opened
                if (usageRef.current[index] !== undefined) {
                    usageRef.current[index] += 1;
                    console.log(`Question ${index + 1} used: ${usageRef.current[index]} times`);
                    console.log('Current usage distribution:', usageRef.current);
                }

                setActiveCardIndex(index);
                setHighlightedCard(index);
                setRecentHistory(prev => {
                    const newHistory = [index, ...prev];
                    return newHistory.slice(0, 2); 
                });
            };

            const closeCard = () => {
                setActiveCardIndex(null);
                setHighlightedCard(null); 
            };

            const resetGame = () => {
                setGameState('input');
                setIsAutoRandomizing(false);
                setIsStopping(false);
                if (randomizerRef.current) clearTimeout(randomizerRef.current);
            };

            // Calculate the next target index based on Weighted Random
            const getNaturalBalancedTargetIndex = () => {
                const counts = usageRef.current;
                const minVal = Math.min(...counts);
                
                // --- Algorithm เพื่อความเนียน ---
                // 1. หา Candidate: เอาเฉพาะข้อที่ห่างจากข้อที่น้อยสุดไม่เกิน 1
                //    (แปลว่าถ้ามีข้อที่ออกไป 0 ครั้ง กับ 1 ครั้ง -> สุ่มได้ทั้งคู่)
                //    (แต่ถ้ามีข้อที่ออกไป 2 ครั้งแล้ว -> จะไม่เอามาสุ่มจนกว่าเพื่อนจะตามทัน)
                
                let candidates = [];
                let weights = [];
                
                counts.forEach((count, idx) => {
                    // อนุญาตให้สุ่มได้ ถ้าจำนวนครั้งที่ออก ยังไม่เกิน (ค่าน้อยสุด + 1)
                    if (count <= minVal + 1) {
                        candidates.push(idx);
                        
                        // ถ่วงน้ำหนัก: 
                        // ถ้าเท่าน้อยสุด (เช่น ยังไม่เคยออก) ให้โอกาส 10 (มาก)
                        // ถ้ามากกว่าน้อยสุด (เช่น ออกไปแล้ว 1 ครั้ง) ให้โอกาส 3 (น้อยกว่า)
                        // ทำให้ "มีโอกาส" ที่จะซ้ำได้ แต่ก็น้อยกว่าข้อใหม่
                        if (count === minVal) {
                            weights.push(10); 
                        } else {
                            weights.push(3);
                        }
                    }
                });

                // Weighted Random Selection
                const totalWeight = weights.reduce((a, b) => a + b, 0);
                let randomVal = Math.random() * totalWeight;
                
                for (let i = 0; i < candidates.length; i++) {
                    randomVal -= weights[i];
                    if (randomVal <= 0) {
                        return candidates[i];
                    }
                }
                
                // Fallback (เผื่อกรณี error)
                return candidates[candidates.length - 1];
            };

            const runRandomizerStep = (currentIndex) => {
                const nextIndex = (currentIndex + 1) % questions.length;
                setHighlightedCard(nextIndex);

                let nextDelay = speedRef.current;

                if (stoppingRef.current) {
                    // Logic to control stopping exactly at target
                    if (stoppingStepsRemainingRef.current > 0) {
                        stoppingStepsRemainingRef.current--;
                        
                        // Calculate easing delay
                        const totalSteps = stoppingStepsTotalRef.current;
                        const remaining = stoppingStepsRemainingRef.current;
                        const progress = 1 - (remaining / totalSteps); // 0 to 1
                        
                        // Quadratic ease-out for delay
                        const minDelay = 50;
                        const maxDelay = 400; // ADJUSTED: Reduced from 700 to 400
                        nextDelay = minDelay + (maxDelay - minDelay) * (progress * progress);

                        if (stoppingStepsRemainingRef.current === 0) {
                             // Final Step Reached
                             stoppingRef.current = false;
                             setTimeout(() => {
                                 setIsAutoRandomizing(false);
                                 setIsStopping(false);
                                 openCard(nextIndex);
                             }, 800); // REVERTED: Back to 800ms
                             return;
                        }
                    }
                } 
                
                randomizerRef.current = setTimeout(() => {
                    runRandomizerStep(nextIndex);
                }, nextDelay);
            };

            const toggleRandomizer = () => {
                if (isAutoRandomizing) {
                    if (!stoppingRef.current) {
                        // START STOPPING PHASE
                        stoppingRef.current = true;
                        setIsStopping(true);

                        // 1. Determine the winner based on NATURAL balanced usage
                        const targetIndex = getNaturalBalancedTargetIndex();
                        targetIndexRef.current = targetIndex;

                        // 2. Calculate steps to land on target
                        const currentIdx = highlightedCard !== null ? highlightedCard : 0;
                        const minSteps = 10; // ADJUSTED: Reduced from 20 to 10
                        
                        // Formula: (Target - Current + Total) % Total
                        let stepsToTarget = (targetIndex - currentIdx + questions.length) % questions.length;
                        
                        // Ensure we spin at least minSteps
                        while (stepsToTarget < minSteps) {
                            stepsToTarget += questions.length;
                        }

                        // Set refs for the animation loop
                        stoppingStepsRemainingRef.current = stepsToTarget;
                        stoppingStepsTotalRef.current = stepsToTarget;
                        
                        console.log(`Stopping: Aiming for #${targetIndex + 1}, Steps: ${stepsToTarget}`);
                    }
                } else {
                    // START SPINNING
                    setIsAutoRandomizing(true);
                    setIsStopping(false);
                    stoppingRef.current = false;
                    speedRef.current = 50; 
                    
                    let startIdx = highlightedCard !== null ? highlightedCard : 0;
                    runRandomizerStep(startIdx);
                }
            };

            const handleLogoUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedBase64 = await compressImage(file, 400); 
                        setLogoUrl(compressedBase64);
                        try { localStorage.setItem('debate_logo', compressedBase64); } catch (err) { console.error("Storage full"); }
                    } catch (error) { alert("เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ"); }
                }
            };

            const handleBgUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedBase64 = await compressImage(file, 1280);
                        setBgUrl(compressedBase64);
                        try { localStorage.setItem('debate_bg', compressedBase64); } catch (err) { alert("รูปภาพใหญ่เกินไป"); }
                    } catch (error) { alert("เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ"); }
                }
            };

            const handleExport = () => {
                const data = { questions: inputText, logo: logoUrl, bg: bgUrl };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'debate_backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.questions) {
                            setInputText(data.questions);
                            localStorage.setItem('debate_questions_v6', data.questions);
                        }
                        if (data.logo) { setLogoUrl(data.logo); localStorage.setItem('debate_logo', data.logo); }
                        if (data.bg) { setBgUrl(data.bg); localStorage.setItem('debate_bg', data.bg); }
                        alert('กู้คืนข้อมูลสำเร็จ (Restore Complete)');
                        window.location.reload(); 
                    } catch (err) { alert('ไฟล์ไม่ถูกต้อง'); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const getQuestionStyle = (text) => {
                const length = text.length;
                let fontSize;
                
                if (length < 50) {
                    fontSize = 'clamp(3rem, 7vw, 6rem)'; 
                } else if (length < 100) {
                    fontSize = 'clamp(2.5rem, 6vw, 4.5rem)';
                } else {
                    fontSize = 'clamp(1.8rem, 4vw, 3.2rem)';
                }
                
                return {
                    fontSize,
                    lineHeight: '1.8', 
                    wordBreak: 'break-word',
                    overflowWrap: 'break-word',
                    width: '100%',
                    padding: '0 30px' 
                };
            };

            return (
                <div className="h-screen w-screen overflow-hidden relative flex flex-col bg-[#1e2542]">
                    <div ref={flashRef} className="flash-overlay"></div>
                    <div className="absolute inset-0 z-0 pointer-events-none">
                        {bgUrl && (
                            <div className="absolute inset-0">
                                <img src={bgUrl} alt="Background" className="w-full h-full object-cover blur-sm opacity-50" />
                            </div>
                        )}
                        <div className="absolute top-0 left-0 w-[50vw] h-[50vw] bg-[#00c0fa]/20 blur-[120px] rounded-full mix-blend-screen"></div>
                        <div className="absolute bottom-0 right-0 w-[50vw] h-[50vw] bg-[#a855f7]/20 blur-[120px] rounded-full mix-blend-screen"></div>
                    </div>

                    <header className={`relative z-20 flex justify-between items-center px-6 py-4 border-b border-white/10 bg-slate-900/50 backdrop-blur-md shrink-0 transition-opacity duration-300 ${activeCardIndex !== null ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                        <div className="flex items-center gap-4">
                            <div className="cursor-pointer" onClick={() => fileInputRef.current.click()}>
                                <img 
                                    src={logoUrl} 
                                    alt="Logo"
                                    onError={(e) => { e.target.src = "https://placehold.co/100x100/0f172a/00c0fa?text=LOGO"; }}
                                    className="h-16 w-auto object-contain"
                                />
                                <input type="file" ref={fileInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" />
                            </div>

                            <h1 className="text-2xl md:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-[#00c0fa] to-white hidden md:block py-2 leading-relaxed drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]">
                                คำถาม "เจียงใหม่ดีเบต เลือกตั้ง 69"
                            </h1>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            {gameState === 'input' && (
                                <>
                                    <button onClick={handleExport} className="p-2 text-green-400 hover:text-green-300 hover:bg-green-400/10 rounded-lg transition-colors" title="สำรองข้อมูล">
                                        <Icons.Download />
                                    </button>
                                    <button onClick={() => importInputRef.current.click()} className="p-2 text-orange-400 hover:text-orange-300 hover:bg-orange-400/10 rounded-lg transition-colors" title="กู้คืนข้อมูล">
                                        <Icons.UploadCloud />
                                        <input type="file" ref={importInputRef} onChange={handleImport} className="hidden" accept=".json" />
                                    </button>
                                    <div className="w-px h-6 bg-white/20 mx-1"></div>
                                    <button onClick={() => bgInputRef.current.click()} className="p-2 text-[#00c0fa]/50 hover:text-[#00c0fa] hover:bg-[#00c0fa]/10 rounded-lg transition-colors" title="เปลี่ยนรูปพื้นหลัง">
                                        <Icons.Image />
                                        <input type="file" ref={bgInputRef} onChange={handleBgUpload} className="hidden" accept="image/*" />
                                    </button>
                                </>
                            )}
                            
                            {gameState === 'playing' && (
                                <button 
                                    onClick={resetGame}
                                    className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-[#00c0fa] hover:text-white transition-colors rounded-lg hover:bg-[#00c0fa]/10"
                                >
                                    CM108 x MCOT x สวท.เชียงใหม่
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="relative z-10 flex-1 min-h-0 w-full p-4 md:p-8 lg:p-12 flex flex-col">
                        
                        {gameState === 'input' && (
                            <div key="input-view" className="flex-1 w-full max-w-4xl mx-auto flex flex-col justify-center animate-page-enter">
                                <div className="bg-slate-800/80 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-white/10 flex flex-col h-[70vh]">
                                    <h2 className="text-2xl font-bold mb-4 text-[#00c0fa]">รายการคำถาม</h2>
                                    <textarea
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        className="flex-1 w-full bg-slate-900/50 rounded-xl p-4 text-lg text-white border border-white/10 focus:border-[#00c0fa] focus:ring-1 focus:ring-[#00c0fa] focus:outline-none resize-none mb-6 leading-relaxed"
                                        placeholder="พิมพ์คำถามที่นี่... (ใช้เครื่องหมาย | เพื่อขึ้นบรรทัดใหม่ในคำถาม)"
                                    ></textarea>
                                    <button 
                                        onClick={handleStart}
                                        className="w-full py-4 bg-gradient-to-r from-[#00c0fa] to-blue-600 rounded-xl text-xl font-bold text-white shadow-lg hover:shadow-[#00c0fa]/40 hover:scale-[1.01] transition-all active:scale-95"
                                    >
                                        เริ่มระบบสุ่ม (Start)
                                    </button>
                                </div>
                            </div>
                        )}

                        {gameState === 'playing' && activeCardIndex === null && (
                            <div key="grid-view" className={`w-full h-full flex gap-3 animate-page-enter ${questions.length > 5 ? 'flex-wrap' : ''}`}>
                                {questions.map((q, i) => (
                                    <CardItem 
                                        key={i}
                                        idx={i}
                                        isHighlighted={highlightedCard === i}
                                        isAutoRandomizing={isAutoRandomizing}
                                        openCard={openCard}
                                        setHighlightedCard={setHighlightedCard}
                                        totalCards={questions.length}
                                    />
                                ))}
                            </div>
                        )}

                        {gameState === 'playing' && activeCardIndex !== null && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md animate-in fade-in duration-200" onClick={closeCard}>
                                <div 
                                    className="relative w-[95vw] max-w-7xl max-h-[90vh] bg-[#1e2542] border border-white/10 rounded-3xl p-8 md:p-12 shadow-2xl shadow-[#00c0fa]/20 flex flex-col py-10" 
                                    onClick={(e) => e.stopPropagation()}
                                >
                                    
                                    <div className="w-full flex justify-between items-center shrink-0 mb-8">
                                        <div className="flex flex-col items-start gap-4">
                                            <div className="text-white text-2xl md:text-4xl font-medium flex items-center gap-3">
                                                <span className="inline-block w-1.5 h-8 md:w-2 md:h-10 bg-[#00c0fa] rounded-full shadow-[0_0_10px_#00c0fa]"></span>
                                                คำถามหมายเลข
                                            </div>
                                            
                                            <div className="relative mt-2 ml-4">
                                                <div className="w-16 h-16 md:w-24 md:h-24 bg-[#00c0fa] rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(0,192,250,0.6)] border-[3px] border-white">
                                                    <span className="text-4xl md:text-5xl font-bold text-white drop-shadow-md">
                                                        {activeCardIndex + 1}
                                                    </span>
                                                </div>
                                                <div className="absolute inset-0 rounded-full border-2 border-[#00c0fa]/50 animate-ping"></div>
                                            </div>
                                        </div>

                                        <div className="flex flex-col items-end">
                                            <img 
                                                src={logoUrl} 
                                                alt="Logo"
                                                className="h-16 md:h-24 object-contain opacity-100 drop-shadow-xl"
                                            />
                                        </div>
                                    </div>

                                    <div className="flex-1 w-full flex items-center justify-center px-4">
                                        <h3 
                                            className="font-bold text-center text-white drop-shadow-2xl w-full"
                                            style={getQuestionStyle(questions[activeCardIndex])}
                                        >
                                            {questions[activeCardIndex].split('|').map((line, idx) => (
                                                <React.Fragment key={idx}>
                                                    {line}
                                                    {idx < questions[activeCardIndex].split('|').length - 1 && <br />}
                                                </React.Fragment>
                                            ))}
                                        </h3>
                                    </div>
                                    
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>